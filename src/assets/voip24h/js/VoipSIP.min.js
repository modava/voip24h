var VoipSIP;$(function(){if("undefined"==typeof user&&(user=JSON.parse(localStorage.getItem("SIPCreds"))),!(VoipSIP={config:{password:user.Pass,displayName:user.Display,uri:"sip:"+user.User+"@"+user.Realm,wsServers:user.WSServer,registerExpires:30,traceSip:!0,log:{level:3}},ringtone:document.getElementById("ringtone"),ringbacktone:document.getElementById("ringbacktone"),dtmfTone:document.getElementById("dtmfTone"),Sessions:[],callTimers:{},callActiveID:null,callVolume:99,Stream:null,formatPhone:function(e){var t;return 10===(t=(t=e.indexOf("@")?e.split("@")[0]:e).toString().replace(/[^0-9]/g,"")).length?"("+t.substr(0,3)+") "+t.substr(3,3)+"-"+t.substr(6,4):11===t.length?"("+t.substr(1,3)+") "+t.substr(4,3)+"-"+t.substr(7,4):t},startRingTone:function(){try{VoipSIP.ringtone.play()}catch(e){}},stopRingTone:function(){try{VoipSIP.ringtone.pause()}catch(e){}},startRingbackTone:function(){try{VoipSIP.ringbacktone.play()}catch(e){}},stopRingbackTone:function(){try{VoipSIP.ringbacktone.pause()}catch(e){}},getUniqueID:function(){return Math.random().toString(36).substr(2,9)},newSession:function(e){var t;$(".btnCall").attr("disabled","disabled"),e.displayName=e.remoteIdentity.displayName||e.remoteIdentity.uri.user,e.ctxid=VoipSIP.getUniqueID(),"incoming"===e.direction?(t="Incoming: "+e.displayName,VoipSIP.startRingTone()):(t="Calling: "+e.displayName,VoipSIP.startRingbackTone()),$("#numDisplay").val(""),$("#numDisplay").val(e.displayName),$("#MainCallSipBoard").empty(),$("#MainCallSipBoard").append('<button class="btn btn-danger btn-block btnHangUp" id="MainCallSipBoardbtnHangUp" data-sessionid="'+e.id+'" title="Hangup">Hangup</button>'),VoipSIP.logCall(e,"ringing"),VoipSIP.setCallSessionStatus(t),e.on("progress",function(t){$("#numDisplay").val(""),$("#numDisplay").val(e.displayName),"outgoing"===t.direction&&VoipSIP.setCallSessionStatus("Calling...")}),e.on("connecting",function(t){$("#numDisplay").val(""),$("#numDisplay").val(e.displayName),"outgoing"===t.direction&&VoipSIP.setCallSessionStatus("Connecting...")}),e.on("accepted",function(t){$("#numDisplay").val(""),$("#numDisplay").val(e.displayName),VoipSIP.callActiveID&&VoipSIP.callActiveID!==e.ctxid&&VoipSIP.phoneHoldButtonPressed(VoipSIP.callActiveID),VoipSIP.stopRingbackTone(),VoipSIP.stopRingTone(),VoipSIP.setCallSessionStatus("Answered"),VoipSIP.logCall(e,"answered"),VoipSIP.callActiveID=e.ctxid}),e.on("hold",function(t){$("#numDisplay").val(""),$("#numDisplay").val(e.displayName),VoipSIP.callActiveID=null,VoipSIP.logCall(e,"holding")}),e.on("unhold",function(t){$("#numDisplay").val(""),$("#numDisplay").val(e.displayName),VoipSIP.logCall(e,"resumed"),VoipSIP.callActiveID=e.ctxid}),e.on("muted",function(t){$("#numDisplay").val(""),$("#numDisplay").val(e.displayName),VoipSIP.Sessions[e.ctxid].isMuted=!0,VoipSIP.setCallSessionStatus("Muted")}),e.on("unmuted",function(t){$("#numDisplay").val(""),$("#numDisplay").val(e.displayName),VoipSIP.Sessions[e.ctxid].isMuted=!1,VoipSIP.setCallSessionStatus("Answered")}),e.on("cancel",function(t){$("#numDisplay").val(""),$(".btnCall").removeAttr("disabled"),VoipSIP.stopRingTone(),VoipSIP.stopRingbackTone(),VoipSIP.setCallSessionStatus("Canceled"),"outgoing"===this.direction&&(VoipSIP.callActiveID=null,e=null,VoipSIP.logCall(this,"ended"))}),e.on("bye",function(t){$("#numDisplay").val(""),$(".btnCall").removeAttr("disabled"),VoipSIP.stopRingTone(),VoipSIP.stopRingbackTone(),VoipSIP.setCallSessionStatus(""),VoipSIP.logCall(e,"ended"),VoipSIP.callActiveID=null,e=null}),e.on("failed",function(e){$("#numDisplay").val(""),$(".btnCall").removeAttr("disabled"),VoipSIP.stopRingTone(),VoipSIP.stopRingbackTone(),VoipSIP.setCallSessionStatus("")}),e.on("rejected",function(t){$("#numDisplay").val(""),$(".btnCall").removeAttr("disabled"),VoipSIP.stopRingTone(),VoipSIP.stopRingbackTone(),VoipSIP.setCallSessionStatus("Rejected"),VoipSIP.callActiveID=null,VoipSIP.logCall(this,"ended"),e=null}),VoipSIP.Sessions[e.ctxid]=e},getUserMediaFailure:function(e){window.console.error("getUserMedia failed:",e),VoipSIP.setError(!0,"Media Error.","You must allow access to your microphone.  Check the address bar.",!0)},getUserMediaSuccess:function(e){VoipSIP.Stream=e},setCallSessionStatus:function(e){$("#txtCallStatus").html(e)},setStatus:function(e){$("#txtRegStatus").html('<i class="fa fa-signal"></i> '+e)},logCall:function(e,t){var i={clid:e.displayName,uri:e.remoteIdentity.uri.toString(),id:e.ctxid,time:(new Date).getTime()},o=JSON.parse(localStorage.getItem("sipCalls"));o||(o={}),o.hasOwnProperty(e.ctxid)||(o[i.id]={id:i.id,clid:i.clid,uri:i.uri,start:i.time,flow:e.direction}),"ended"===t&&(o[i.id].stop=i.time),"ended"===t&&"ringing"===o[i.id].status?o[i.id].status="missed":o[i.id].status=t,localStorage.setItem("sipCalls",JSON.stringify(o)),VoipSIP.logShow()},logItem:function(t){$(".btnCall").attr("disabled","disabled");var i,o,n="ended"!==t.status&&"missed"!==t.status,s="ended"!==t.status?'<span id="'+t.id+'"></span>':moment.duration(t.stop-t.start).humanize(),a="";switch(t.status){case"ringing":a="list-group-item-success",i="fa-bell";break;case"missed":a="list-group-item-danger","incoming"===t.flow&&(i="fa-chevron-left bellflagincoming"),"outgoing"===t.flow&&(i="fa-chevron-right bellflagoutgoing");break;case"holding":a="list-group-item-warning",i="fa-pause";break;case"answered":case"resumed":a="list-group-item-info",i="fa-phone-square";break;case"ended":"incoming"===t.flow&&(i="fa-chevron-left bellflagincoming"),"outgoing"===t.flow&&(i="fa-chevron-right bellflagoutgoing")}if(o='<div class="list-group-item sip-logitem clearfix '+a+" Vlabel_"+t.flow+" LavAcTive"+n+'" data-uri="'+t.uri+'" data-sessionid="'+t.id+'" title="Double Click to Call"><div class="clearfix"><div class="pull-left"><i class="fa fa-fw '+i+' fa-fw"></i> <strong>'+VoipSIP.formatPhone(t.uri)+"</strong><br><small>"+moment(t.start).format("MM/DD hh:mm:ss a")+'</small></div><div class="pull-right text-right"><em>'+t.clid+"</em><br>"+s+"</div></div>",n?($(".btnCall").attr("disabled","disabled"),o+='<div class="btn-group btn-group-xs pull-right">',"ringing"===t.status&&"incoming"===t.flow?o+='<button class="btn btn-xs btn-success btnCall" title="Call"><i class="fa fa-phone"></i></button>':o+='<button class="btn btn-xs btn-primary btnHoldResume" title="Hold"><i class="fa fa-pause"></i></button><button class="btn btn-xs btn-info btnTransfer" title="Transfer"><i class="fa fa-random"></i></button><button class="btn btn-xs btn-warning btnMute" title="Mute"><i class="fa fa-fw fa-microphone"></i></button>',o+='<button class="btn btn-xs btn-danger btnHangUp" title="Hangup"><i class="fa fa-stop"></i></button></div>',$("#MainCallSipBoard").append('<button class="btn btn-danger btn-block btnHangUp" id="MainCallSipBoardbtnHangUp" data-sessionid="'+t.id+'" title="Hangup">Hangup</button>'),$("#MainCallSipBoardbtnHangUp").click(function(e){e.preventDefault();var t=$(this).data("sessionid");return VoipSIP.sipHangUp(t),!1})):$(".btnCall").removeAttr("disabled"),o+="</div>",$("#sip-logitems").append(o),"answered"===t.status){var l=document.getElementById(t.id);VoipSIP.callTimers[t.id]=new e(l),VoipSIP.callTimers[t.id].start()}n&&"ringing"!==t.status&&VoipSIP.callTimers[t.id].start({startTime:t.start}),$("#sip-logitems").scrollTop(0)},logShow:function(){var e=JSON.parse(localStorage.getItem("sipCalls")),t=[];null!==e?($("#sip-splash").addClass("hide"),$("#sip-log").removeClass("hide"),$("#sip-logitems").empty(),$("#MainCallSipBoard").empty(),$.each(e,function(e,i){t.push(i)}),t.sort(function(e,t){return t.start-e.start}),$.each(t,function(e,t){VoipSIP.logItem(t)})):($("#sip-splash").removeClass("hide"),$("#sip-log").addClass("hide"))},logClear:function(){localStorage.removeItem("sipCalls"),VoipSIP.logShow()},sipCall:function(e){try{var t=VoipSIP.phone.invite(e,{media:{stream:VoipSIP.Stream,constraints:{audio:!0,video:!1},render:{remote:$("#audioRemote").get()[0]},RTCConstraints:{optional:[{DtlsSrtpKeyAgreement:"true"}]}}});t.direction="outgoing",VoipSIP.newSession(t)}catch(e){throw e}},sipTransfer:function(e){var t=VoipSIP.Sessions[e],i=window.prompt("Enter destination number","");VoipSIP.setCallSessionStatus("<i>Transfering the call...</i>"),t.refer(i)},sipHangUp:function(e){var t=VoipSIP.Sessions[e];t&&(t.startTime?t.bye():t.reject?t.reject():t.cancel&&t.cancel())},sipSendDTMF:function(e){try{VoipSIP.dtmfTone.play()}catch(e){}var t=VoipSIP.callActiveID;t&&VoipSIP.Sessions[t].dtmf(e)},phoneCallButtonPressed:function(e){if($("#numDisplay").val().length>=1){var t=VoipSIP.Sessions[e],i=$("#numDisplay").val();t?t.accept&&!t.startTime&&t.accept({media:{stream:VoipSIP.Stream,constraints:{audio:!0,video:!1},render:{remote:$("#audioRemote").get()[0]},RTCConstraints:{optional:[{DtlsSrtpKeyAgreement:"true"}]}}}):($("#numDisplay").val(""),VoipSIP.sipCall(i))}else $(".btnCall").removeAttr("disabled")},phoneMuteButtonPressed:function(e){var t=VoipSIP.Sessions[e];t.isMuted?t.unmute():t.mute()},phoneHoldButtonPressed:function(e){var t=VoipSIP.Sessions[e];!0===t.isOnHold().local?t.unhold():t.hold()},setError:function(e,t,i,o){if(!0===e){if($("#mdlError p").html(i),$("#mdlError").modal("show"),o){$("#mdlError .modal-header").find("button").remove(),$("#mdlError .modal-header").prepend('<button type="button" class="close" data-dismiss="modal">&times;</button>'),$("#mdlError .modal-title").html(t),$("#mdlError").modal({keyboard:!0})}else $("#mdlError .modal-header").find("button").remove(),$("#mdlError .modal-title").html(t),$("#mdlError").modal({keyboard:!1});$("#numDisplay").prop("disabled","disabled")}else $("#numDisplay").removeProp("disabled"),$("#mdlError").modal("hide")},hasWebRTC:function(){return!!navigator.webkitGetUserMedia||(!!navigator.mozGetUserMedia||(!!navigator.getUserMedia||(VoipSIP.setError(!0,"Unsupported Browser.","Your browser does not support the features required for this phone."),window.console.error("WebRTC support not found"),!1)))}}).hasWebRTC())return!0;localStorage.removeItem("SIPCreds"),confirm("Error Setting Account"),location.reload(!0),VoipSIP.phone=new SIP.UA(VoipSIP.config),VoipSIP.phone.on("connected",function(e){VoipSIP.setStatus("Connected")}),VoipSIP.phone.on("disconnected",function(e){VoipSIP.setStatus("Disconnected"),VoipSIP.setError(!0,"Websocket Disconnected.","An Error occurred connecting to the websocket."),localStorage.removeItem("SIPCreds"),$("#sessions > .session").each(function(e,t){VoipSIP.removeSession(t,500)})}),VoipSIP.phone.on("registered",function(e){window.onbeforeunload=function(){return"If you close this window, you will not be able to make or receive calls from your browser."},window.onunload=function(){localStorage.removeItem("ctxPhone"),VoipSIP.phone.stop()},localStorage.setItem("ctxPhone","true"),$("#mldError").modal("hide"),VoipSIP.setStatus("VOIP24H - "+user.Display),SIP.WebRTC.isSupported()&&SIP.WebRTC.getUserMedia({audio:!0,video:!1},VoipSIP.getUserMediaSuccess,VoipSIP.getUserMediaFailure)}),VoipSIP.phone.on("registrationFailed",function(e){VoipSIP.setError(!0,"Registration Error.","An Error occurred registering your phone. Check your settings."),localStorage.removeItem("SIPCreds"),VoipSIP.setStatus("Error: Registration Failed")}),VoipSIP.phone.on("unregistered",function(e){VoipSIP.setError(!0,"Registration Error.","An Error occurred registering your phone. Check your settings."),localStorage.removeItem("SIPCreds"),VoipSIP.setStatus("Error: Registration Failed")}),VoipSIP.phone.on("invite",function(e){var t=e;t.direction="incoming",VoipSIP.newSession(t)}),$("#sipClient").keydown(function(e){8===e.which&&$("#numDisplay").focus()}),$("#numDisplay").keypress(function(e){13===e.which&&VoipSIP.phoneCallButtonPressed()}),$(".digit").click(function(e){e.preventDefault();var i=$("#numDisplay").val(),o=$(this).data("digit");return t(),$("#numDisplay").val(i+o),VoipSIP.sipSendDTMF(o),!1}),$(".btnCall").click(function(e){$(this).attr("disabled","disabled"),VoipSIP.phoneCallButtonPressed()}),$("#AcbtnCallClean").click(function(){VoipSIP.dtmfTone.play();let e=$("#numDisplay").val();e.length>0&&$("#numDisplay").val(e.substring(0,e.length-1)),t()}),$(".sipLogClear").click(function(e){e.preventDefault(),VoipSIP.logClear()}),$("#sip-logitems").delegate(".sip-logitem .btnCall","click",function(e){$(this).attr("disabled","disabled");var t=$(this).closest(".sip-logitem").data("sessionid");return VoipSIP.phoneCallButtonPressed(t),!1}),$("#sip-logitems").delegate(".sip-logitem .btnHoldResume","click",function(e){var t=$(this).closest(".sip-logitem").data("sessionid");return VoipSIP.phoneHoldButtonPressed(t),!1}),$("#sip-logitems").delegate(".sip-logitem .btnHangUp","click",function(e){var t=$(this).closest(".sip-logitem").data("sessionid");return VoipSIP.sipHangUp(t),!1}),$("#sip-logitems").delegate(".sip-logitem .btnTransfer","click",function(e){var t=$(this).closest(".sip-logitem").data("sessionid");return VoipSIP.sipTransfer(t),!1}),$("#sip-logitems").delegate(".sip-logitem .btnMute","click",function(e){var t=$(this).closest(".sip-logitem").data("sessionid");return VoipSIP.phoneMuteButtonPressed(t),!1}),$("#sip-logitems").delegate(".sip-logitem","dblclick",function(e){e.preventDefault();var t=$(this).data("uri");$("#numDisplay").val(t),VoipSIP.phoneCallButtonPressed()}),$("#sldVolume").on("change",function(){var e=$(this).val()/100,t=$("#btnVol"),i=$("#btnVol").find("i"),o=VoipSIP.callActiveID;return VoipSIP.Sessions[o]&&(VoipSIP.Sessions[o].player.volume=e,VoipSIP.callVolume=e),$("audio").each(function(){$(this).get()[0].volume=e}),e<.1?(t.removeClass(function(e,t){return(t.match(/(^|\s)btn\S+/g)||[]).join(" ")}).addClass("btn btn-sm btn-danger"),i.removeClass().addClass("fa fa-fw fa-volume-off")):e<.8?(t.removeClass(function(e,t){return(t.match(/(^|\s)btn\S+/g)||[]).join(" ")}).addClass("btn btn-sm btn-info"),i.removeClass().addClass("fa fa-fw fa-volume-down")):(t.removeClass(function(e,t){return(t.match(/(^|\s)btn\S+/g)||[]).join(" ")}).addClass("btn btn-sm btn-primary"),i.removeClass().addClass("fa fa-fw fa-volume-up")),!1});var e=function(e,t){var i,o,n,s=document.createElement("span");function a(){var e,t;o+=(e=Date.now(),t=e-i,i=e,t),l()}function l(){s.innerHTML=moment(o).format("mm:ss")}(t=t||{}).delay=t.delay||1e3,t.startTime=t.startTime||Date.now(),e.appendChild(s),o=0,l(),this.start=function(){n||(i=t.startTime,n=setInterval(a,t.delay))},this.stop=function(){n&&(clearInterval(n),n=null)}};function t(){$("#numDisplay").val().length>0?$("#AcbtnCallClean").addClass("active"):$("#AcbtnCallClean").removeClass("active")}setTimeout(function(){VoipSIP.logShow()},2e3)});